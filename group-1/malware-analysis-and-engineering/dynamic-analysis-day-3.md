---
description: Malware behaviours
---

# Dynamic Analysis - Day 3

### **Windows API**



### **The Windows Registry**

* Malware&#x20;
* Persistence: programs that will be run whenever the machine reboots.&#x20;
* Configuration

Those Windows API functions containing **Regb** are interacting with the registry, so they may be interesting when analysing malware samples. They might be using to know if a program is already running or not.&#x20;

.reg scripts are scripts that can be created by the user.&#x20;

Windows API functions may contain ExW which mean that they are the newer version of a legacy function. The W means it is a word, but A (ASCII) or other letters can be use to determine the type.&#x20;

* Wininet.dll: application layer functions like http, ftp, tls:. Some functions of this library are: InternetOpen, InternetReadFile...
* ws2\_32.dll: berkeley compatible sockets. Some functions contained in this library are: socket, bind, listen, accept, and many more.&#x20;

The equivalent of InternetOpen is WSAStartup, which is used before any connection is established.

### DLLs

They are basically PEs (with the difference of a bit) with more exports than imports. The equivalent to main in a DLL is DLLMain. Malware are often DLLs because they are easier to inject into a running process. Windows DLLs are also used to inject malicious code.

### Processes

They are basically containers for execution. Malware using processes normally are based on opening new processes using the function CreateProcess.

### Threads

A process is normally more than one thread. In malware, threads within a process and they share the memory but they have different registers and stack, so they can be used to inject malicious code. Using LoadLibrary, a malicious DLL can be loaded into a process creating a new thread.&#x20;

### Services

Services are basically processes running in the background and it is a classical way of running code. They are normally executed as SYSTEM or privileged accounts. Some malware use funcions like CreateService, StartService, etc.&#x20;

### COM (Component Object Model)

The entire OS is a set ob objects that can exchange message and interact between them. COM objects are being used for malware providing containers, dealing with macros, etc. The analysis of COM usage is tricky.&#x20;

### Exceptions

What happens when the program is in unexpected circumstances. They are interesting because they are static. They can be used to exploit a stack overflow overwriting the pointer to a malicious code.&#x20;

### User-land and Kernel-land

For every process, the memory is divided into two sections: the user land (from 0x0000000 to 0x7ffeffff) and then the kernel land (0x80000000 to 0xffffffff). Moreover, there is a no access region that includes the heap. The program can make system calls. In previous Windows versions, the way to perform a systemcall was to call int 2e. For modern versions, the instruction sysenter is used. Systemcalls are placed in Ntoskml.exe, where most dlls are (essential the kernel).The Ntfdll.dll is the native dll can be used by the user with the wrappers to the Windows kernel.&#x20;

<figure><img src="../../.gitbook/assets/Captura de pantalla 2023-03-14 a las 16.49.03.png" alt=""><figcaption></figcaption></figure>

### CARO

Organization that created a way of denominating malware due to the differences between companies and countries differences, to make a generic criteria. The criteria includes: Platform.Familty.Variant.Mods...

### Malware terms

* Virus: piece of code that cannot be executed by itself so it infects another programs (getting the entry point, for example) to run the malicious code.&#x20;
* Dropper: a program that contains another inside and simply drops it.
* Downloader: the same as dropper but it gets the another program from an endpoint.
* Backdoor: gives remote access, e.g. a shell.&#x20;
* RAT: Remote Administration Tool, used by admins to manage the system remotely.&#x20;
* Trojan: the combination of more than one.&#x20;
* PUP (Pontentially Unwanted Program): similar as adware. Grayware (install something -extensions- in the browser to play with advertisements). Replaces ads, add other adds, clickers, etc. They are not exploiting the system or taking sensitive information.

### Common behaviors

* Downloaders and launchers: it is basically a multistage type (several people behind). The first stage is an organization that is in charge of infecting the system (malvertisers, etc.) to make the user click and download something. Some other times they simply get into the system using known vulnerabilities. Then the second stage is to execute the downloaded piece of malware. Normally functions like URLDownloadtoFileA followed by WinExec are used. Normally there are different modules dealing with different taks (C2C, encrypting, etc.) which are loaded in the first stage when the malware is downloaded.
* Backdoors: very common malware behaviour giving the remote control over the system to the attackers (run commands, shell, hardcoded commands, etc.).&#x20;
  * Reverse shell --> connection originated in the victim machine that allows the attacker to run commands. Netcat is the common command used to establish these type of shells.&#x20;
  * Windows reverse shell: they can be basic (using CreateProcess alone) or multithreaded (support multiple connections) using 1 socket with two pipes and two threads at the same time. This type is often used to manipulate data coming or going out over the socket.
  * RATs (Remote Administration Tools): is a system tool used for remote management to steal information and move laterally.&#x20;
  * Botnet: collection of all the bots that are infected. The difference with RATs is that is thought to be controlling multiple victims at the same time. It uses a star topology as all victims are connected to the C2. However, there can be multiple C2s that are called multiserver but there is always a master. Moreover, the structure is hierarchical or P2P.

**Resiliency:** how long can a botnet survive if a bot is discovered. For example, in a star topology, if a bot is discovered, you only have to look for the domain of the controller and the master would be caught up. In other topologies the resiliency is higher as the master is not directly connected to the bots.&#x20;

The comparison in metrics between different topologies is:

<figure><img src="../../.gitbook/assets/Captura de pantalla 2023-03-14 a las 17.53.54.png" alt=""><figcaption></figcaption></figure>

Domain fast-flux --> the idea is that the IP associated to a domain changes every X minutes in order to avoid the tracking of the main or master controllers in a botnet.

Domain fronting --> technique that uses a legitimate domain to redirect requests to the malicious server. As TLS is used, the used endpoint cannot be traced.&#x20;

### Credentials stealers

Three strategies:

* Programs intercepting credentials when user logs in
* Programs dumping stored creds
* Programs logging keystrokes

**GINA interception** --> there is one dll called msgina.dll that enables legitimate third parties to customise the logon process. Malware actors can use this dll to get user credentials because this dll is loaded by Winlogon during the logon process.

**Hash dumping** --> getting hashes to crack them offline. With DLL injection (making a program load an specific dll).

**Keystroke logging** --> there are two techniques: Hooking is using SetWindowsHookEx (the malware program is called every time a key is pressed) and polling (using GetAsyncKeyState) to poll the state of the keyboard every time. These techniques are called user space keyloggers. Kernel space keyloggers are part of a rootkit that may act as keyboard drivers.

### Persistence

Different types:

* AppInit\_DLLs: loading a dll into every process that load User32.dll. Every program loading a dll loads the persistence program.&#x20;
* Winlogon notify: loading the dll when an event happens.
* Trojanized system binaries: the program takes a system binary or dll that is replaced with another one that has the same content plus the malicious code. It is easy to detect in systems with integrity mechanisms.&#x20;
* DLL load-order hijacking: modifying the paths that are going to be used to look for the dll. Is basically taking a dll which is in System and move it high in the loading order.

